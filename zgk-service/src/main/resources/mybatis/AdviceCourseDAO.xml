<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.thinkjoy.gk.dao.IAdviceCourseDAO">


    <select id="getMajorBatchByCourse" resultType="cn.thinkjoy.gk.domain.MajorBatchCompareRtn">
        SELECT count(*) as num,3in7.batch as batch,
        dict.name as batchName
        FROM
        zgk_zj_3in7 3in7
        LEFT JOIN zgk_data_dict dict on dict.type = 'BATCHTYPE' and dict.dictId =3in7.batch
        <where>
            <!-- 查询专业对应  -->
            <foreach collection="subjects" separator="OR" item="obj" open="(" close=") OR">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
                3in7.selectCount = 0
        </where>
        GROUP BY 3in7.batch
    </select>
    <!-- 查询院校差异(相同的不显示 但是在这里不去重,代码中去重,提高sql执行速度)  -->
    <select id="getUniversityDiffByCourse" resultType="java.util.Map">
        SELECT
        university.id as universityId,
        university.name as universityName,
        university.areaid as areaId,
        3in7.batch as batch,
        dict.name as batchName,
        3in7.major as majorName,
        3in7.majorCode as majorCode,
        (university.areaid=#{currAreaId}) as isCurrArea,
        university.rank as rank
        from
        zgk_zj_3in7 3in7
        INNER JOIN
        zgk_university university
        ON 3in7.universityId = university.id
        and 3in7.eduLevel = university.educationLevel
        LEFT JOIN zgk_data_dict dict ON dict.type = 'BATCHTYPE' and dict.dictId =3in7.batch
        where 3in7.selectCount>0
        and 3in7.year=#{year}
        AND 3in7.universityId is not null
        <if test="subjects">
            AND
            <foreach collection="subjects" open="(" close=")" separator="OR" item="obj">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
        </if>
        <if test="areaId!=null">
            AND university.areaid =#{areaId}
        </if>
        <if test="type!=null">
            AND university.type = #{type}
        </if>
        <if test="batch!=null">
            AND 3in7.batch = #{batch}
        </if>

    </select>
    <!-- 查询选择课程组合对应的批次 -->
    <select id="queryBatch" resultType="java.util.Map">
        SELECT
        3in7.batch AS batch,
        dict.name AS batchName
        FROM
        zgk_zj_3in7 3in7
        LEFT JOIN
        zgk_data_dict dict
        ON type = 'BATCHTYPE' AND dict.dictId = 3in7.batch
        <where>
            <if test="year!=null">
                and `year` =#{year}
            </if>
            <foreach collection="subjects1" separator="OR" item="obj">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
            <if test="subjects2!=null">OR</if>
            <foreach collection="subjects2" separator="OR" item="obj">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
        </where>
        GROUP BY 3in7.batch
    </select>
    <!-- 查询选择课程组合对应的省份 -->
    <select id="queryArea" resultType="java.util.Map">
        SELECT
        university.areaid as areaid,
        (SELECT name from zgk_province where id =university.areaid) as areaName
        from zgk_zj_3in7 3in7
        <!-- 查询院校信息,以universityID和educationLevel关联 -->
        INNER JOIN zgk_university university
        ON 3in7.universityId = university.id
        and 3in7.eduLevel = university.educationLevel
        <where>
            <foreach collection="subjects1" separator="OR" item="obj">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
            <if test="subjects2!=null">OR</if>
            <foreach collection="subjects2" separator="OR" item="obj">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
        </where>
        GROUP BY university.areaid
    </select>



    <select id="queryUnivType" resultType="java.util.Map">
        SELECT
        university.type as typeId,
        (SELECT name from zgk_data_dict where type = 'PROPERTY' AND dictId =university.type) as typeName
        from zgk_zj_3in7 3in7
        <!-- 查询院校信息,以universityID和educationLevel关联 -->
        INNER JOIN zgk_university university
        ON 3in7.universityId = university.id
        and 3in7.eduLevel = university.educationLevel
        <where>
            <foreach collection="subjects1" separator="OR" item="obj">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
            <if test="subjects2!=null">OR</if>
            <foreach collection="subjects2" separator="OR" item="obj">
                3in7.selectSubject like CONCAT('%',#{obj},'%')
            </foreach>
        </where>
        GROUP BY university.type
    </select>
</mapper>
